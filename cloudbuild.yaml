steps:
- name: gcr.io/cloud-builders/npm
  args: ['ci']

- name: gcr.io/cloud-builders/gcloud
  entrypoint: bash
  args:
    - -c
    - |
      set -e

      # Install PostgreSQL client
      apt-get update -y
      apt-get install -y postgresql-client

      # Fetch DATABASE_URL from Secret Manager
      DB_URL="$$(gcloud secrets versions access latest --secret=DATABASE_URL --project=project-6c0d0bce-1897-4806-852)"
      
      # Extract credentials from DATABASE_URL
      # Format: postgresql://user:password@/database?host=/cloudsql/...
      DB_USER="postgres"
      DB_PASS=$$(echo "$$DB_URL" | sed -n 's|.*://postgres:\([^@]*\)@.*|\1|p')
      DB_NAME="inventory_db"

      # Download Cloud SQL Auth Proxy
      curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.11.4/cloud-sql-proxy.linux.amd64
      chmod +x cloud-sql-proxy

      # Start Cloud SQL Proxy in TCP mode on localhost:5432
      ./cloud-sql-proxy --port=5432 project-6c0d0bce-1897-4806-852:asia-southeast1:inventory-postgres &
      sleep 10

      # Run database migration using TCP connection
      PGPASSWORD="$$DB_PASS" psql -h 127.0.0.1 -p 5432 -U "$$DB_USER" -d "$$DB_NAME" -f migrations/init.sql

- name: gcr.io/cloud-builders/gcloud
  args:
    - app
    - deploy
    - --quiet

options:
  logging: CLOUD_LOGGING_ONLY

timeout: 1200s
